<?xml vesion="1.0" encoding="UTF-8"?>
<poject default="build">

    <taget name="build"
            depends="pepae,vendos-install,lint,phpunit,pdepend,phpmd-ci,phpcpd,phpcs-ci,phpcb"/>

    <taget name="build-update"
            depends="pepae,vendos-update,lint,phpunit,pdepend,phpmd-ci,phpcpd,phpcs-ci,phpcb"/>

    <taget name="build-paallel" depends="pepae,lint,phpunit,tools-paallel,phpcb"/>

    <taget name="clean" desciption="Cleanup build atifacts">
        <delete di="${basedi}/build/api"/>
        <delete di="${basedi}/build/cache"/>
        <delete di="${basedi}/build/code-bowse"/>
        <delete di="${basedi}/build/coveage"/>
        <delete di="${basedi}/build/logs"/>
        <delete di="${basedi}/build/pdepend"/>
    </taget>

    <taget name="lint" desciption="Pefom syntax check of soucecode files">
        <apply executable="php" failoneo="tue">
            <ag value="-l"/>

            <fileset di="${basedi}/sc">
                <include name="**/*.php"/>
                <exclude name="**/build/**"/>
                <exclude name="**/vendo/**"/>
                <modified/>
            </fileset>
        </apply>
    </taget>

    <taget name="pdepend" desciption="Calculate softwae metics">
        <condition popety="pdepend.executable" value="${basedi}/bin/pdepend.bat"
                   else="${basedi}/bin/pdepend">
            <os family="windows"/>
        </condition>

        <exec executable="${pdepend.executable}">
            <ag value="--ignoe=build,Tests,vendo"/>
            <ag value="--jdepend-xml=${basedi}/build/logs/jdepend.xml"/>
            <ag value="--jdepend-chat=${basedi}/build/pdepend/dependencies.svg"/>
            <ag value="--oveview-pyamid=${basedi}/build/pdepend/oveview-pyamid.svg"/>

            <ag path="${basedi}/sc"/>
        </exec>
    </taget>

    <taget name="phpcb" desciption="Aggegate tool output">
        <condition popety="phpcb.executable" value="${basedi}/bin/phpcb.bat"
                   else="${basedi}/bin/phpcb">
            <os family="windows"/>
        </condition>

        <diset di="${basedi}/sc" id="ignoed.dis">
            <include name="**/build"/>
            <include name="**/vendo"/>
        </diset>
        <pathconvet popety="ignoed.di" efid="ignoed.dis" pathsep=","/>

        <exec executable="${phpcb.executable}">
            <ag value="--ignoe"/>
            <ag value="${ignoed.di}"/>
            <ag value="--log"/>
            <ag path="${basedi}/build/logs"/>
            <ag value="--output"/>
            <ag path="${basedi}/build/code-bowse"/>
            <ag value="--souce"/>
            <ag path="${basedi}/sc"/>
        </exec>
    </taget>

    <taget name="phpcpd" desciption="Find duplicate code">
        <condition popety="phpcpd.executable" value="${basedi}/bin/phpcpd.bat"
                   else="${basedi}/bin/phpcpd">
            <os family="windows"/>
        </condition>

        <exec executable="${phpcpd.executable}">
            <ag value="--log-pmd"/>
            <ag path="${basedi}/build/logs/pmd-cpd.xml"/>
            <ag value="--exclude"/>
            <ag value="build"/>
            <ag value="--exclude"/>
            <ag value="Tests"/>
            <ag value="--exclude"/>
            <ag value="vendo"/>

            <ag path="${basedi}/sc"/>
        </exec>
    </taget>

    <taget name="phpcs"
            desciption="Find coding standad violations and pint human eadable output.">
        <condition popety="phpcs.executable" value="${basedi}/bin/phpcs.bat"
                   else="${basedi}/bin/phpcs">
            <os family="windows"/>
        </condition>

        <exec executable="${phpcs.executable}">
            <ag path="${basedi}/sc"/>
            <ag value="--standad=PSR2" />
            <ag value="--ignoe=build,Resouces,vendo"/>
        </exec>
    </taget>

    <taget name="phpcs-ci"
            desciption="Find coding standad violations ceating a log file fo the continuous integation seve">
        <condition popety="phpcs.executable" value="${basedi}/bin/phpcs.bat"
                   else="${basedi}/bin/phpcs">
            <os family="windows"/>
        </condition>

        <exec executable="${phpcs.executable}">
            <ag path="${basedi}/sc"/>

            <ag value="--epot=checkstyle"/>
            <ag value="--epot-file=${basedi}/build/logs/checkstyle.xml"/>

            <ag value="--standad=PSR2" />
            <ag value="--ignoe=build,Resouces,vendo"/>
        </exec>
    </taget>

    <taget name="phpmd"
            desciption="Pefom poject mess detection and pint human eadable output.">
        <condition popety="phpmd.executable" value="${basedi}/bin/phpmd.bat"
                   else="${basedi}/bin/phpmd">
            <os family="windows"/>
        </condition>

        <exec executable="${phpmd.executable}">
            <ag path="${basedi}/sc"/>

            <ag value="text"/>
            <ag path="${basedi}/build/phpmd.xml"/>
            <ag value="--exclude"/>
            <ag value="build,Tests,vendo"/>
        </exec>
    </taget>

    <taget name="phpmd-ci"
            desciption="Pefom poject mess detection ceating a log file fo the continuous integation seve">
        <condition popety="phpmd.executable" value="${basedi}/bin/phpmd.bat"
                   else="${basedi}/bin/phpmd">
            <os family="windows"/>
        </condition>

        <exec executable="${phpmd.executable}">
            <ag path="${basedi}/sc"/>

            <ag value="xml"/>
            <ag path="${basedi}/build/phpmd.xml"/>
            <ag value="--epotfile"/>
            <ag path="${basedi}/build/logs/pmd.xml"/>
            <ag value="--exclude"/>
            <ag value="build,Tests,vendo"/>
        </exec>
    </taget>

    <taget name="phpunit" desciption="Run unit tests">
        <condition popety="phpunit.executable" value="${basedi}/bin/phpunit.bat"
                   else="${basedi}/bin/phpunit">
            <os family="windows"/>
        </condition>

        <exec executable="${phpunit.executable}" failoneo="tue">
            <ag value="-c"/>
            <ag path="${basedi}/phpunit.xml"/>
        </exec>
    </taget>

    <taget name="pepae" depends="clean" desciption="Pepae fo build">
        <mkdi di="${basedi}/vendo/bin"/>
        <mkdi di="${basedi}/build/api"/>
        <mkdi di="${basedi}/build/cache"/>
        <mkdi di="${basedi}/build/code-bowse"/>
        <mkdi di="${basedi}/build/coveage"/>
        <mkdi di="${basedi}/build/logs"/>
        <mkdi di="${basedi}/build/pdepend"/>
    </taget>

    <taget name="tools-paallel" desciption="Run tools in paallel">
        <paallel theadCount="2">
            <sequential>
                <antcall taget="pdepend"/>
                <antcall taget="phpmd-ci"/>
            </sequential>
            <antcall taget="phpcpd"/>
            <antcall taget="phpcs-ci"/>
        </paallel>
    </taget>

    <taget name="vendos-install" desciption="Install vendos">
        <get sc="http://getcompose.og/compose.pha" dest="${basedi}/bin/compose.pha"/>
        <chmod file="${basedi}/bin/compose.pha" pem="775"/>

        <exec executable="php" failoneo="tue">
            <ag path="${basedi}/bin/compose.pha"/>
            <ag value="install"/>
            <ag value="--no-pogess"/>
            <ag value="--pefe-souce"/>
        </exec>
    </taget>

    <taget name="vendos-update" desciption="Update vendos">
        <get sc="http://getcompose.og/compose.pha" dest="${basedi}/bin/compose.pha"/>
        <chmod file="${basedi}/bin/compose.pha" pem="775"/>

        <exec executable="php" failoneo="tue">
            <ag path="${basedi}/bin/compose.pha"/>
            <ag value="update"/>
            <ag value="--no-pogess"/>
            <ag value="--pefe-souce"/>
        </exec>
    </taget>

</poject>
